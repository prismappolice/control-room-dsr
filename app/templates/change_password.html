{% extends "base.html" %}

{% block title %}Change Password{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-md-6 mx-auto">
            <div class="card">
                <div class="card-header">
                    <h4 class="mb-0">
                        <i class="fas fa-key"></i> Change Password
                    </h4>
                </div>
                <div class="card-body">
                    <!-- Flash Messages -->
                    {% with messages = get_flashed_messages(with_categories=true) %}
                        {% if messages %}
                            {% for category, message in messages %}
                                <div class="alert alert-{{ 'danger' if category == 'error' else 'success' }} alert-dismissible fade show" role="alert">
                                    {{ message }}
                                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                                </div>
                            {% endfor %}
                        {% endif %}
                    {% endwith %}
                    
                    <form method="POST">
                        <div class="mb-3">
                            <label for="current_password" class="form-label">
                                <i class="fas fa-lock"></i> Current Password <span class="text-danger">*</span>
                            </label>
                            <input type="password" class="form-control" id="current_password" name="current_password" required>
                            <div class="form-text">Enter your current password to verify your identity</div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="new_password" class="form-label">
                                <i class="fas fa-key"></i> New Password <span class="text-danger">*</span>
                            </label>
                            <input type="password" class="form-control" id="new_password" name="new_password" 
                                   required minlength="6" onkeyup="checkPasswordStrength()">
                            <div class="form-text">Password must be at least 6 characters long</div>
                            <div id="password-strength" class="mt-1"></div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="confirm_password" class="form-label">
                                <i class="fas fa-check-circle"></i> Confirm New Password <span class="text-danger">*</span>
                            </label>
                            <input type="password" class="form-control" id="confirm_password" name="confirm_password" 
                                   required onkeyup="checkPasswordMatch()">
                            <div id="password-match" class="mt-1"></div>
                        </div>
                        
                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="show_passwords" onchange="togglePasswordVisibility()">
                                <label class="form-check-label" for="show_passwords">
                                    Show passwords
                                </label>
                            </div>
                        </div>
                        
                        <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                            {% if current_user.user_type == 'admin' %}
                                <a href="{{ url_for('admin.dashboard') }}" class="btn btn-secondary me-md-2">
                                    <i class="fas fa-times"></i> Cancel
                                </a>
                            {% elif current_user.user_type == 'district' %}
                                <a href="{{ url_for('district.dashboard') }}" class="btn btn-secondary me-md-2">
                                    <i class="fas fa-times"></i> Cancel
                                </a>
                            {% elif current_user.user_type == 'controlroom' %}
                                <a href="{{ url_for('district.controlroom_dashboard') }}" class="btn btn-secondary me-md-2">
                                    <i class="fas fa-times"></i> Cancel
                                </a>
                            {% endif %}
                            
                            <button type="submit" class="btn btn-warning" id="submit-btn" disabled>
                                <i class="fas fa-save"></i> Change Password
                            </button>
                        </div>
                    </form>
                </div>
                <div class="card-footer text-muted">
                    <small>
                        <i class="fas fa-info-circle"></i> 
                        For security reasons, you will need to log in again after changing your password.
                    </small>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function checkPasswordStrength() {
    const password = document.getElementById('new_password').value;
    const strengthDiv = document.getElementById('password-strength');
    const submitBtn = document.getElementById('submit-btn');
    
    if (password.length < 6) {
        strengthDiv.innerHTML = '<span class="badge bg-danger">Too short (minimum 6 characters)</span>';
        submitBtn.disabled = true;
        return;
    }
    
    let strength = 0;
    if (password.length >= 8) strength++;
    if (password.match(/[a-z]/)) strength++;
    if (password.match(/[A-Z]/)) strength++;
    if (password.match(/[0-9]/)) strength++;
    if (password.match(/[^a-zA-Z0-9]/)) strength++;
    
    switch(strength) {
        case 0:
        case 1:
            strengthDiv.innerHTML = '<span class="badge bg-danger">Weak</span>';
            break;
        case 2:
            strengthDiv.innerHTML = '<span class="badge bg-warning">Fair</span>';
            break;
        case 3:
            strengthDiv.innerHTML = '<span class="badge bg-info">Good</span>';
            break;
        case 4:
        case 5:
            strengthDiv.innerHTML = '<span class="badge bg-success">Strong</span>';
            break;
    }
    
    checkFormValidity();
}

function checkPasswordMatch() {
    const password = document.getElementById('new_password').value;
    const confirmPassword = document.getElementById('confirm_password').value;
    const matchDiv = document.getElementById('password-match');
    
    if (confirmPassword === '') {
        matchDiv.innerHTML = '';
        return;
    }
    
    if (password === confirmPassword) {
        matchDiv.innerHTML = '<span class="badge bg-success">Passwords match</span>';
    } else {
        matchDiv.innerHTML = '<span class="badge bg-danger">Passwords do not match</span>';
    }
    
    checkFormValidity();
}

function checkFormValidity() {
    const password = document.getElementById('new_password').value;
    const confirmPassword = document.getElementById('confirm_password').value;
    const currentPassword = document.getElementById('current_password').value;
    const submitBtn = document.getElementById('submit-btn');
    
    const isValid = currentPassword.length > 0 && 
                   password.length >= 6 && 
                   confirmPassword === password;
    
    submitBtn.disabled = !isValid;
}

function togglePasswordVisibility() {
    const showPasswords = document.getElementById('show_passwords').checked;
    const passwordInputs = document.querySelectorAll('input[type="password"]');
    
    passwordInputs.forEach(input => {
        input.type = showPasswords ? 'text' : 'password';
    });
}

// Check form validity on all password inputs
document.getElementById('current_password').addEventListener('keyup', checkFormValidity);
document.getElementById('new_password').addEventListener('keyup', function() {
    checkPasswordStrength();
    checkPasswordMatch();
});
document.getElementById('confirm_password').addEventListener('keyup', checkPasswordMatch);
</script>
{% endblock %}
{% extends "base.html" %}

{% block title %}Control Room Dashboard - Control Room DSR{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2><i class="fas fa-building me-2"></i>Control Room Dashboard</h2>
                <div class="badge bg-warning fs-6">Control Room User</div>
            </div>
        </div>
    </div>
    
    <!-- Upload Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-upload me-2"></i>File Uploads</h5>
                </div>
                <div class="card-body">
                    <form method="POST" action="{{ url_for('district.upload_file') }}" enctype="multipart/form-data">
                        <div class="row mb-3">
                            <div class="col-md-3">
                                <label for="upload_date" class="form-label">Date * <small class="text-muted">(Last 7 days)</small></label>
                                <input type="date" class="form-control" id="upload_date" name="upload_date" required>
                            </div>
                            <div class="col-md-3">
                                <label for="upload_type" class="form-label">Upload Type *</label>
                                <select class="form-select" id="upload_type" name="upload_type" required>
                                    <option value="">Select Type</option>
                                    <option value="periscope">Periscope</option>
                                    <option value="vip_engagements">VIP Engagements</option>
                                    <option value="ps_rtm">334PS RTM&E-Sakshya 334(A)case Non CPS&CPS Employees</option>
                                    <option value="next_24hrs_forecast">Next 24 Hours Forecast</option>
                                    <option value="dg_teleconference">DG Sir Teleconference</option>
                                    <option value="weekly_dsrs">Weekly DSRs</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label for="file" class="form-label">File *</label>
                                <input type="file" class="form-control" id="file" name="file" required 
                                       accept=".pdf,.xlsx,.xls,.docx,.doc">
                                <div class="form-text">Supported formats: PDF, Excel, Word (Max: 16MB)</div>
                            </div>
                            <div class="col-md-2 d-flex align-items-end">
                                <button type="submit" class="btn btn-primary w-100">
                                    <i class="fas fa-upload me-1"></i>Upload
                                </button>
                            </div>
                        </div>
                        
                        <div class="file-preview" style="display: none;"></div>
                    </form>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Upload Categories -->
    <div class="row mb-4">
        <div class="col-md-4">
            <div class="card h-100">
                <div class="card-body text-center">
                    <div class="upload-icon mb-3">
                        <i class="fas fa-search-location fa-3x text-primary"></i>
                    </div>
                    <h5>Periscope</h5>
                    <p class="text-muted">Upload periscope related documents and reports</p>
                    <div class="upload-area" data-type="periscope">
                        <i class="fas fa-cloud-upload-alt fa-2x text-muted mb-2"></i>
                        <p class="mb-0">Drag & Drop files here</p>
                        <small class="text-muted">or click to browse</small>
                        <input type="file" class="d-none" accept=".pdf,.xlsx,.xls,.docx,.doc">
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-4">
            <div class="card h-100">
                <div class="card-body text-center">
                    <div class="upload-icon mb-3">
                        <i class="fas fa-user-tie fa-3x text-success"></i>
                    </div>
                    <h5>VIP Engagements</h5>
                    <p class="text-muted">Upload VIP engagement schedules and reports</p>
                    <div class="upload-area" data-type="vip_engagements">
                        <i class="fas fa-cloud-upload-alt fa-2x text-muted mb-2"></i>
                        <p class="mb-0">Drag & Drop files here</p>
                        <small class="text-muted">or click to browse</small>
                        <input type="file" class="d-none" accept=".pdf,.xlsx,.xls,.docx,.doc">
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-4">
            <div class="card h-100">
                <div class="card-body text-center">
                    <div class="upload-icon mb-3">
                        <i class="fas fa-shield-alt fa-3x text-warning"></i>
                    </div>
                    <h5>334PS RTM&E-Sakshya</h5>
                    <p class="text-muted">Upload police station records and employee data</p>
                    <div class="upload-area" data-type="ps_rtm">
                        <i class="fas fa-cloud-upload-alt fa-2x text-muted mb-2"></i>
                        <p class="mb-0">Drag & Drop files here</p>
                        <small class="text-muted">or click to browse</small>
                        <input type="file" class="d-none" accept=".pdf,.xlsx,.xls,.docx,.doc">
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- New Upload Categories -->
    <div class="row mb-4">
        <div class="col-md-4">
            <div class="card h-100 border-purple">
                <div class="card-body text-center">
                    <div class="upload-icon mb-3">
                        <i class="fas fa-clock fa-3x" style="color: #8e44ad;"></i>
                    </div>
                    <h5 style="color: #8e44ad;">Next 24 Hours Forecast</h5>
                    <p class="text-muted">Upload forecast documents (PDF, Excel, etc.)</p>
                    <div class="upload-area" data-type="next_24hrs_forecast">
                        <i class="fas fa-cloud-upload-alt fa-2x text-muted mb-2"></i>
                        <p class="mb-0">Drag & Drop files here</p>
                        <small class="text-muted">or click to browse</small>
                        <input type="file" class="d-none" accept=".pdf,.xlsx,.xls,.docx,.doc">
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-4">
            <div class="card h-100 border-danger">
                <div class="card-body text-center">
                    <div class="upload-icon mb-3">
                        <i class="fas fa-video fa-3x text-danger"></i>
                    </div>
                    <h5 class="text-danger">DG Sir Teleconference</h5>
                    <p class="text-muted">Upload teleconference related documents</p>
                    <div class="upload-area" data-type="dg_teleconference">
                        <i class="fas fa-cloud-upload-alt fa-2x text-muted mb-2"></i>
                        <p class="mb-0">Drag & Drop files here</p>
                        <small class="text-muted">or click to browse</small>
                        <input type="file" class="d-none" accept=".pdf,.xlsx,.xls,.docx,.doc">
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-4">
            <div class="card h-100 border-info">
                <div class="card-body text-center">
                    <div class="upload-icon mb-3">
                        <i class="fas fa-calendar-week fa-3x text-info"></i>
                    </div>
                    <h5 class="text-info">Weekly DSRs</h5>
                    <p class="text-muted">Upload weekly DSR reports and summaries</p>
                    <div class="upload-area" data-type="weekly_dsrs">
                        <i class="fas fa-cloud-upload-alt fa-2x text-muted mb-2"></i>
                        <p class="mb-0">Drag & Drop files here</p>
                        <small class="text-muted">or click to browse</small>
                        <input type="file" class="d-none" accept=".pdf,.xlsx,.xls,.docx,.doc">
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Recent Uploads -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-clock me-2"></i>Recent Uploads</h5>
                </div>
                <div class="card-body">
                    {% if recent_uploads %}
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Type</th>
                                    <th>Filename</th>
                                    <th>Upload Time</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for upload in recent_uploads %}
                                <tr>
                                    <td>{{ upload.date.strftime('%d-%m-%Y') }}</td>
                                    <td>
                                        {% if upload.upload_type == 'periscope' %}
                                            <span class="badge bg-primary">Periscope</span>
                                        {% elif upload.upload_type == 'vip_engagements' %}
                                            <span class="badge bg-success">VIP Engagements</span>
                                        {% elif upload.upload_type == 'ps_rtm' %}
                                            <span class="badge bg-warning text-dark">334PS RTM&E</span>
                                        {% elif upload.upload_type == 'next_24hrs_forecast' %}
                                            <span class="badge" style="background-color: #8e44ad;">Next 24 Hours Forecast</span>
                                        {% elif upload.upload_type == 'dg_teleconference' %}
                                            <span class="badge bg-danger">DG Sir Teleconference</span>
                                        {% elif upload.upload_type == 'weekly_dsrs' %}
                                            <span class="badge bg-info">Weekly DSRs</span>
                                        {% else %}
                                            <span class="badge bg-secondary">{{ upload.upload_type }}</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <i class="fas fa-file me-2"></i>
                                        {{ upload.original_filename }}
                                    </td>
                                    <td>{{ upload.uploaded_at.strftime('%d-%m-%Y %H:%M') }}</td>
                                    <td>
                                        <div class="btn-group" role="group">
                                            <a href="{{ url_for('district.download_upload', upload_id=upload.id) }}" 
                                               class="btn btn-sm btn-outline-primary" title="Download">
                                                <i class="fas fa-download"></i>
                                            </a>
                                            <a href="{{ url_for('district.view_upload', upload_id=upload.id) }}" 
                                               class="btn btn-sm btn-outline-info" target="_blank" title="View">
                                                <i class="fas fa-eye"></i>
                                            </a>
                                            <button class="btn btn-sm btn-outline-danger delete-upload-btn" 
                                                    data-upload-id="{{ upload.id }}" 
                                                    data-filename="{{ upload.original_filename }}" 
                                                    title="Delete">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="text-center py-4">
                        <i class="fas fa-upload fa-3x text-muted mb-3"></i>
                        <h6>No uploads yet</h6>
                        <p class="text-muted">Start by uploading your first document</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Set today's date as default and restrict to last 7 days
function setUploadDateRestrictions() {
    const dateInput = document.getElementById('upload_date');
    const today = new Date();
    const sevenDaysAgo = new Date();
    sevenDaysAgo.setDate(today.getDate() - 7);
    
    const formatDate = (date) => {
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
    };
    
    dateInput.setAttribute('min', formatDate(sevenDaysAgo));
    dateInput.setAttribute('max', formatDate(today));
    dateInput.valueAsDate = today;
}

setUploadDateRestrictions();

// Get main form elements
const mainForm = document.querySelector('form[action*="upload"]');
const mainFileInput = document.getElementById('file');
const mainUploadType = document.getElementById('upload_type');
const mainUploadDate = document.getElementById('upload_date');

// Drag and Drop functionality for upload areas
document.querySelectorAll('.upload-area').forEach(area => {
    const uploadType = area.getAttribute('data-type');
    
    // Click to browse
    area.addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        
        // Set the upload type in main form
        mainUploadType.value = uploadType;
        
        // Trigger main file input
        mainFileInput.click();
    });
    
    // Prevent default drag behaviors
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        area.addEventListener(eventName, preventDefaults, false);
    });
    
    function preventDefaults(e) {
        e.preventDefault();
        e.stopPropagation();
    }
    
    // Highlight drop area
    ['dragenter', 'dragover'].forEach(eventName => {
        area.addEventListener(eventName, function() {
            this.style.borderColor = '#0d6efd';
            this.style.backgroundColor = '#e7f1ff';
        });
    });
    
    ['dragleave', 'drop'].forEach(eventName => {
        area.addEventListener(eventName, function() {
            this.style.borderColor = '#dee2e6';
            this.style.backgroundColor = '';
        });
    });
    
    // Handle dropped files
    area.addEventListener('drop', function(e) {
        const files = e.dataTransfer.files;
        
        if (files.length > 0) {
            const file = files[0];
            
            // Validate date first
            const uploadDate = mainUploadDate.value;
            if (!uploadDate) {
                alert('Please select an upload date first');
                return;
            }
            
            // Validate date is within last 7 days
            const selectedDate = new Date(uploadDate);
            const today = new Date();
            const sevenDaysAgo = new Date();
            sevenDaysAgo.setDate(today.getDate() - 7);
            today.setHours(23, 59, 59, 999);
            sevenDaysAgo.setHours(0, 0, 0, 0);
            
            if (selectedDate > today) {
                alert('Future dates are not allowed. Please select today or a previous date within last 7 days.');
                return;
            }
            
            if (selectedDate < sevenDaysAgo) {
                alert('Upload date is too old. Please select a date within the last 7 days only.');
                return;
            }
            
            // Check file type
            const allowedTypes = ['.pdf', '.xlsx', '.xls', '.docx', '.doc'];
            const fileExt = '.' + file.name.split('.').pop().toLowerCase();
            
            if (!allowedTypes.includes(fileExt)) {
                alert('Invalid file type. Please upload PDF, Excel, or Word documents only.');
                return;
            }
            
            // Set file to main form input
            const dataTransfer = new DataTransfer();
            dataTransfer.items.add(file);
            mainFileInput.files = dataTransfer.files;
            
            // Set upload type
            mainUploadType.value = uploadType;
            
            // Update display
            area.querySelector('p').textContent = `Selected: ${file.name}`;
            
            // Optional: Auto-submit with confirmation
            if (confirm(`Upload "${file.name}" as ${formatUploadTypeName(uploadType)}?`)) {
                mainForm.submit();
            }
        }
    });
});

// When main file input changes, update upload area display and auto-submit
mainFileInput.addEventListener('change', function() {
    if (this.files.length > 0) {
        const fileName = this.files[0].name;
        const uploadType = mainUploadType.value;
        
        // Update corresponding upload area
        if (uploadType) {
            const area = document.querySelector(`.upload-area[data-type="${uploadType}"]`);
            if (area) {
                area.querySelector('p').textContent = `Selected: ${fileName}`;
            }
            
            // Auto-submit with confirmation when file selected from upload areas
            if (confirm(`Upload "${fileName}" as ${formatUploadTypeName(uploadType)}?`)) {
                mainForm.submit();
            } else {
                // Reset if cancelled
                this.value = '';
                area.querySelector('p').textContent = 'Drag & Drop files here';
            }
        }
    }
});

function formatUploadTypeName(type) {
    const names = {
        'periscope': 'Periscope',
        'vip_engagements': 'VIP Engagements',
        'ps_rtm': '334PS RTM&E',
        'next_24hrs_forecast': 'Next 24 Hours Forecast',
        'dg_teleconference': 'DG Sir Teleconference',
        'weekly_dsrs': 'Weekly DSRs'
    };
    return names[type] || type;
}

// Delete upload functionality
document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('.delete-upload-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const uploadId = this.getAttribute('data-upload-id');
            const filename = this.getAttribute('data-filename');
            
            if (confirm(`Are you sure you want to delete "${filename}"?`)) {
                deleteUpload(uploadId);
            }
        });
    });
});

function deleteUpload(uploadId) {
    fetch(`/district/delete_upload/${uploadId}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('File deleted successfully');
            location.reload();
        } else {
            alert('Error: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('An error occurred while deleting the file');
    });
}
</script>
{% endblock %}

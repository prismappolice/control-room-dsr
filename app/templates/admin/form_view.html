{% extends "base.html" %}

{% block title %}{{ form_config.name }} - Admin View{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h2><i class="fas fa-file-alt me-2"></i>{{ form_config.name }} - All Districts</h2>
                    {% if filter_date %}
                    <div class="mt-2">
                        <span class="badge bg-info fs-6">
                            <i class="fas fa-calendar-alt me-1"></i>Filtered by Date: {{ filter_date }}
                        </span>
                        <a href="{{ url_for('admin.form_view', form_type=form_type) }}" class="btn btn-sm btn-outline-warning ms-2">
                            <i class="fas fa-times me-1"></i>Clear Date Filter
                        </a>
                    </div>
                    {% endif %}
                </div>
                <a href="{{ url_for('admin.dashboard') }}" class="btn btn-outline-secondary">
                    <i class="fas fa-arrow-left me-1"></i>Back to Dashboard
                </a>
            </div>
        </div>
    </div>
    
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5><i class="fas fa-table me-2"></i>Form Data Summary</h5>
                        <button class="btn btn-success" id="exportBtn">
                            <i class="fas fa-file-excel me-1"></i>Export to Excel
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    {% if form_data %}
                    <div class="table-responsive">
                        {% if form_type == 'head_wise_crime_weekly' %}
                        <!-- Special grouped table for Head Wise Crime Weekly Statement -->
                        <table class="table table-bordered table-sm" id="formDataTable" style="font-size: 0.85rem;">
                            <thead>
                                <!-- Main category headers -->
                                <tr class="text-center fw-bold">
                                    <th rowspan="2" class="align-middle bg-secondary text-white">S.No</th>
                                    <th rowspan="2" class="align-middle bg-secondary text-white">District</th>
                                    <th rowspan="2" class="align-middle bg-secondary text-white">Date</th>
                                    <th colspan="6" class="bg-success text-white">Bodily Offences</th>
                                    <th colspan="5" class="bg-warning">Property Offences</th>
                                    <th colspan="5" class="bg-danger text-white">Crime Against Women</th>
                                    <th rowspan="2" class="align-middle bg-info text-white">SC-ST</th>
                                    <th rowspan="2" class="align-middle bg-info text-white">Riotings</th>
                                    <th rowspan="2" class="align-middle bg-info text-white">Kidnap</th>
                                    <th rowspan="2" class="align-middle bg-info text-white">Cheat</th>
                                    <th rowspan="2" class="align-middle bg-info text-white">Cyber</th>
                                    <th colspan="2" class="bg-primary text-white">Road Accidents</th>
                                    <th rowspan="2" class="align-middle bg-secondary text-white">Other IPC</th>
                                    <th rowspan="2" class="align-middle bg-secondary text-white">SLL</th>
                                    <th rowspan="2" class="align-middle bg-secondary text-white">174</th>
                                    <th rowspan="2" class="align-middle bg-secondary text-white">Missing</th>
                                    <th rowspan="2" class="align-middle bg-secondary text-white">Others</th>
                                    <th rowspan="2" class="align-middle bg-dark text-white">Actions</th>
                                </tr>
                                <!-- Sub-headers -->
                                <tr class="text-center" style="font-size: 0.75rem;">
                                    <th class="bg-success bg-opacity-75">Murder<br>gain</th>
                                    <th class="bg-success bg-opacity-75">Murders</th>
                                    <th class="bg-success bg-opacity-75">Attempt</th>
                                    <th class="bg-success bg-opacity-75">C.Homi</th>
                                    <th class="bg-success bg-opacity-75">Grave<br>Hurts</th>
                                    <th class="bg-success bg-opacity-75">Simple<br>Hurts</th>
                                    <th class="bg-warning bg-opacity-75">Dacoity</th>
                                    <th class="bg-warning bg-opacity-75">Robbery</th>
                                    <th class="bg-warning bg-opacity-75">H.Bs<br>Day</th>
                                    <th class="bg-warning bg-opacity-75">H.Bs<br>Night</th>
                                    <th class="bg-warning bg-opacity-75">Ordinary<br>Thefts</th>
                                    <th class="bg-danger bg-opacity-75 text-white">Rape</th>
                                    <th class="bg-danger bg-opacity-75 text-white">Others</th>
                                    <th class="bg-danger bg-opacity-75 text-white">POCSO<br>Grave</th>
                                    <th class="bg-danger bg-opacity-75 text-white">POCSO<br>Non-Gr</th>
                                    <th class="bg-danger bg-opacity-75 text-white">Dowry</th>
                                    <th class="bg-primary bg-opacity-75 text-white">Fatal</th>
                                    <th class="bg-primary bg-opacity-75 text-white">Non-Fatal</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for entry in form_data %}
                                <tr class="text-center">
                                    <td>{{ loop.index }}</td>
                                    <td class="text-start">{{ entry.district }}</td>
                                    <td>{{ entry.date.strftime('%d-%m-%Y') }}</td>
                                    <td data-field="bodily_murder_gain" data-entry="{{ entry.id }}">-</td>
                                    <td data-field="bodily_murders" data-entry="{{ entry.id }}">-</td>
                                    <td data-field="bodily_attempt_murder" data-entry="{{ entry.id }}">-</td>
                                    <td data-field="bodily_c_homicides" data-entry="{{ entry.id }}">-</td>
                                    <td data-field="bodily_grave_hurts" data-entry="{{ entry.id }}">-</td>
                                    <td data-field="bodily_simple_hurts" data-entry="{{ entry.id }}">-</td>
                                    <td data-field="property_dacoity" data-entry="{{ entry.id }}">-</td>
                                    <td data-field="property_robbery" data-entry="{{ entry.id }}">-</td>
                                    <td data-field="property_hbs_day" data-entry="{{ entry.id }}">-</td>
                                    <td data-field="property_hbs_night" data-entry="{{ entry.id }}">-</td>
                                    <td data-field="property_ordinary_thefts" data-entry="{{ entry.id }}">-</td>
                                    <td data-field="caw_rape" data-entry="{{ entry.id }}">-</td>
                                    <td data-field="caw_others" data-entry="{{ entry.id }}">-</td>
                                    <td data-field="caw_pocso_sec34_56_grave" data-entry="{{ entry.id }}">-</td>
                                    <td data-field="caw_pocso_others_sec12" data-entry="{{ entry.id }}">-</td>
                                    <td data-field="caw_dowry_death" data-entry="{{ entry.id }}">-</td>
                                    <td data-field="sc_st_cases" data-entry="{{ entry.id }}">-</td>
                                    <td data-field="riotings" data-entry="{{ entry.id }}">-</td>
                                    <td data-field="kidnappings" data-entry="{{ entry.id }}">-</td>
                                    <td data-field="cheatings" data-entry="{{ entry.id }}">-</td>
                                    <td data-field="cyber_offences" data-entry="{{ entry.id }}">-</td>
                                    <td data-field="road_accidents_fatal" data-entry="{{ entry.id }}">-</td>
                                    <td data-field="road_accidents_non_fatal" data-entry="{{ entry.id }}">-</td>
                                    <td data-field="other_ipc_stup_drugs" data-entry="{{ entry.id }}">-</td>
                                    <td data-field="sll_cases" data-entry="{{ entry.id }}">-</td>
                                    <td data-field="crpc_174" data-entry="{{ entry.id }}">-</td>
                                    <td data-field="missing_cases" data-entry="{{ entry.id }}">-</td>
                                    <td data-field="others_if_any" data-entry="{{ entry.id }}">-</td>
                                    <td>
                                        <div class="btn-group" role="group">
                                            <button class="btn btn-sm btn-outline-info view-details-btn" data-entry-id="{{ entry.id }}">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                        {% else %}
                        <!-- Standard table for other forms -->
                        <table class="table table-striped table-hover" id="formDataTable">
                            <thead class="table-dark">
                                <tr>
                                    <th>District</th>
                                    <th>Date</th>
                                    {% for field in form_config.fields %}
                                        {% if field.type not in ['section', 'subsection'] %}
                                    <th>{{ field.label }}</th>
                                        {% endif %}
                                    {% endfor %}
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for entry in form_data %}
                                <tr>
                                    <td>{{ entry.district }}</td>
                                    <td>{{ entry.date.strftime('%d-%m-%Y') }}</td>
                                    {% for field in form_config.fields %}
                                        {% if field.type not in ['section', 'subsection'] %}
                                    <td class="field-data" data-field="{{ field.name }}" data-entry="{{ entry.id }}">
                                        <!-- Data will be populated by JavaScript -->
                                    </td>
                                        {% endif %}
                                    {% endfor %}
                                    <td>
                                        <div class="btn-group" role="group">
                                            <button class="btn btn-sm btn-outline-info view-details-btn" data-entry-id="{{ entry.id }}">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                            <a href="{{ url_for('admin.district_view', district_name=entry.district) }}" 
                                               class="btn btn-sm btn-outline-primary">
                                                <i class="fas fa-map-marker-alt"></i>
                                            </a>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                        {% endif %}
                    </div>
                    
                    <!-- Pagination -->
                    <nav aria-label="Form data pagination" class="mt-3">
                        <ul class="pagination justify-content-center">
                            <li class="page-item disabled">
                                <a class="page-link" href="#" tabindex="-1">Previous</a>
                            </li>
                            <li class="page-item active">
                                <a class="page-link" href="#">1</a>
                            </li>
                            <li class="page-item">
                                <a class="page-link" href="#">2</a>
                            </li>
                            <li class="page-item">
                                <a class="page-link" href="#">3</a>
                            </li>
                            <li class="page-item">
                                <a class="page-link" href="#">Next</a>
                            </li>
                        </ul>
                    </nav>
                    {% else %}
                    <div class="text-center py-5">
                        <i class="fas fa-file-alt fa-3x text-muted mb-3"></i>
                        <h5>No data available</h5>
                        <p class="text-muted">No districts have submitted data for {{ form_config.name }} yet.</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Detail Modal -->
<div class="modal fade" id="detailModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Entry Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="modalContent">
                <!-- Details will be loaded here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="printBtn">
                    <i class="fas fa-print me-1"></i>Print
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Template data for JavaScript -->
<script type="application/json" id="formData">{{ form_data | tojson }}</script>
<script type="application/json" id="formConfig">{{ form_config | tojson }}</script>

<script>
// Load template data
let formDataJson = [];
let formConfigJson = {};

try {
    formDataJson = JSON.parse(document.getElementById('formData').textContent || '[]');
    formConfigJson = JSON.parse(document.getElementById('formConfig').textContent || '{}');
} catch (e) {
    console.error('Error loading form data:', e);
}

// Populate table data on page load
document.addEventListener('DOMContentLoaded', function() {
    formDataJson.forEach(entry => {
        if (formConfigJson.fields) {
            formConfigJson.fields.forEach(field => {
                const cell = document.querySelector(`[data-field="${field.name}"][data-entry="${entry.id}"]`);
                if (cell && entry.data) {
                    cell.textContent = entry.data[field.name] || 'N/A';
                }
            });
        }
    });

    // Add event listeners
    document.querySelectorAll('.view-details-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const entryId = parseInt(this.getAttribute('data-entry-id'));
            viewDetails(entryId);
        });
    });

    const exportBtn = document.getElementById('exportBtn');
    if (exportBtn) {
        exportBtn.addEventListener('click', exportToExcel);
    }

    const printBtn = document.getElementById('printBtn');
    if (printBtn) {
        printBtn.addEventListener('click', printModal);
    }
});

function viewDetails(entryId) {
    const entry = formDataJson.find(e => e.id === entryId);
    if (!entry) return;
    
    const modalContent = document.getElementById('modalContent');
    let html = `
        <div class="row mb-3">
            <div class="col-md-6">
                <strong>District:</strong> ${entry.district}
            </div>
            <div class="col-md-6">
                <strong>Date:</strong> ${new Date(entry.date).toLocaleDateString('en-GB')}
            </div>
        </div>
        <hr>
        <h6>Form Data:</h6>
        <div class="row">
    `;
    
    if (formConfigJson.fields && entry.data) {
        formConfigJson.fields.forEach(field => {
            html += `
                <div class="col-md-6 mb-3">
                    <div class="card">
                        <div class="card-body">
                            <h6 class="card-title">${field.label}</h6>
                            <p class="card-text">${entry.data[field.name] || 'N/A'}</p>
                        </div>
                    </div>
                </div>
            `;
        });
    }
    
    html += '</div>';
    modalContent.innerHTML = html;
    
    const modal = new bootstrap.Modal(document.getElementById('detailModal'));
    modal.show();
}

function exportToExcel() {
    let csvContent = "data:text/csv;charset=utf-8,";
    
    // Header
    let headers = ['District', 'Date'];
    if (formConfigJson.fields) {
        formConfigJson.fields.forEach(field => {
            headers.push(field.label);
        });
    }
    csvContent += headers.join(',') + '\n';
    
    // Data rows
    formDataJson.forEach(entry => {
        let row = [entry.district, new Date(entry.date).toLocaleDateString('en-GB')];
        if (formConfigJson.fields && entry.data) {
            formConfigJson.fields.forEach(field => {
                row.push(entry.data[field.name] || '');
            });
        }
        csvContent += row.map(field => `"${field}"`).join(',') + '\n';
    });
    
    // Download
    const encodedUri = encodeURI(csvContent);
    const link = document.createElement("a");
    link.setAttribute("href", encodedUri);
    link.setAttribute("download", `${formConfigJson.name || 'form'}_data.csv`);
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}

function printModal() {
    const modalContent = document.getElementById('modalContent').innerHTML;
    const printWindow = window.open('', '_blank');
    printWindow.document.write(`
        <html>
            <head>
                <title>${formConfigJson.name || 'Form'} - Entry Details</title>
                <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
            </head>
            <body class="p-4">
                <h2>${formConfigJson.name || 'Form'} - Entry Details</h2>
                ${modalContent}
                <script>window.onload = function() { window.print(); }<\/script>
            </body>
        </html>
    `);
    printWindow.document.close();
}
</script>
{% endblock %}

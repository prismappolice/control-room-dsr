{% extends "base.html" %}

{% block title %}{{ form_config.name }} - Admin View{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h2><i class="fas fa-file-alt me-2"></i>{{ form_config.name }} - All Districts</h2>
                    {% if filter_date %}
                    <div class="mt-2">
                        <span class="badge bg-info fs-6">
                            <i class="fas fa-calendar-alt me-1"></i>Filtered by Date: {{ filter_date }}
                        </span>
                        <a href="{{ url_for('admin.form_view', form_type=form_type) }}" class="btn btn-sm btn-outline-warning ms-2">
                            <i class="fas fa-times me-1"></i>Clear Date Filter
                        </a>
                    </div>
                    {% endif %}
                </div>
                <a href="{{ url_for('admin.dashboard') }}" class="btn btn-outline-secondary">
                    <i class="fas fa-arrow-left me-1"></i>Back to Dashboard
                </a>
            </div>
        </div>
    </div>
    
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5><i class="fas fa-table me-2"></i>Form Data Summary</h5>
                        {% if form_type == 'head_wise_crime_weekly' %}
                        <button class="btn btn-danger" id="exportPdfBtn">
                            <i class="fas fa-file-pdf me-1"></i>Export to PDF
                        </button>
                        {% else %}
                        <button class="btn btn-success" id="exportBtn">
                            <i class="fas fa-file-excel me-1"></i>Export to Excel
                        </button>
                        {% endif %}
                    </div>
                </div>
                <div class="card-body">
                    {% if form_data %}
                    <div class="table-responsive">
                        {% if form_type == 'head_wise_crime_weekly' %}
                        <!-- Special grouped table for Head Wise Crime Weekly Statement -->
                        <style>
                            #crimeWeeklyTable th, #crimeWeeklyTable td {
                                white-space: nowrap;
                                min-width: 60px;
                                max-width: 100px;
                                word-wrap: break-word;
                                padding: 8px 4px;
                            }
                            #crimeWeeklyTable th.district-col {
                                min-width: 120px;
                            }
                            @media print {
                                #crimeWeeklyTable {
                                    font-size: 10px;
                                }
                            }
                        </style>
                        <table class="table table-bordered table-sm" id="crimeWeeklyTable" style="font-size: 0.85rem;">
                            <thead>
                                <!-- Main category headers -->
                                <tr class="text-center fw-bold" style="line-height: 1.2;">
                                    <th rowspan="2" class="align-middle bg-secondary text-white" style="width: 50px;">S.No</th>
                                    <th rowspan="2" class="align-middle bg-secondary text-white district-col" style="min-width: 120px;">District</th>
                                    <th rowspan="2" class="align-middle bg-secondary text-white" style="width: 90px;">Date</th>
                                    <th colspan="6" class="bg-success text-white">Bodily Offences</th>
                                    <th colspan="5" class="bg-warning">Property Offences</th>
                                    <th colspan="5" class="bg-danger text-white">Crime Against Women</th>
                                    <th rowspan="2" class="align-middle bg-info text-white" style="width: 70px;">SC-ST<br>Cases</th>
                                    <th rowspan="2" class="align-middle bg-info text-white" style="width: 70px;">Riotings<br>(147-149)</th>
                                    <th rowspan="2" class="align-middle bg-info text-white" style="width: 70px;">Kidnap<br>(363,369)</th>
                                    <th rowspan="2" class="align-middle bg-info text-white" style="width: 70px;">Cheat<br>(420)</th>
                                    <th rowspan="2" class="align-middle bg-info text-white" style="width: 70px;">Cyber<br>Offences</th>
                                    <th colspan="2" class="bg-primary text-white">Road Accidents</th>
                                    <th rowspan="2" class="align-middle bg-secondary text-white" style="width: 70px;">Other<br>IPC</th>
                                    <th rowspan="2" class="align-middle bg-secondary text-white" style="width: 70px;">SLL<br>cases</th>
                                    <th rowspan="2" class="align-middle bg-secondary text-white" style="width: 60px;">174<br>Cr.P.C</th>
                                    <th rowspan="2" class="align-middle bg-secondary text-white" style="width: 70px;">Missing<br>Cases</th>
                                    <th rowspan="2" class="align-middle bg-secondary text-white" style="width: 70px;">Others<br>if any</th>
                                    <th rowspan="2" class="align-middle bg-dark text-white" style="width: 80px;">Actions</th>
                                </tr>
                                <!-- Sub-headers -->
                                <tr class="text-center" style="font-size: 0.7rem; line-height: 1.1;">
                                    <th class="bg-success bg-opacity-75" style="width: 70px;">Murder<br>for gain<br>(302,379)</th>
                                    <th class="bg-success bg-opacity-75" style="width: 70px;">Murders<br>(302 IPC)</th>
                                    <th class="bg-success bg-opacity-75" style="width: 70px;">Attempt<br>Murder<br>(307)</th>
                                    <th class="bg-success bg-opacity-75" style="width: 70px;">C.Homi<br>cides<br>(304)</th>
                                    <th class="bg-success bg-opacity-75" style="width: 70px;">Grave<br>Hurts<br>(325,326)</th>
                                    <th class="bg-success bg-opacity-75" style="width: 70px;">Simple<br>Hurts<br>(323,324)</th>
                                    <th class="bg-warning bg-opacity-75" style="width: 70px;">Dacoity<br>(395 IPC)</th>
                                    <th class="bg-warning bg-opacity-75" style="width: 70px;">Robbery<br>(392,394)</th>
                                    <th class="bg-warning bg-opacity-75" style="width: 70px;">H.Bs by<br>Day<br>(454,380)</th>
                                    <th class="bg-warning bg-opacity-75" style="width: 70px;">H.Bs by<br>Night<br>(457,380)</th>
                                    <th class="bg-warning bg-opacity-75" style="width: 70px;">Ordinary<br>Thefts<br>(379,380)</th>
                                    <th class="bg-danger bg-opacity-75 text-white" style="width: 70px;">Rape<br>(376 IPC)</th>
                                    <th class="bg-danger bg-opacity-75 text-white" style="width: 70px;">Others<br>(354,<br>354A,D)</th>
                                    <th class="bg-danger bg-opacity-75 text-white" style="width: 80px;">POCSO<br>Sec 3&4/<br>5&6 Grave</th>
                                    <th class="bg-danger bg-opacity-75 text-white" style="width: 80px;">POCSO<br>Others<br>Sec 12</th>
                                    <th class="bg-danger bg-opacity-75 text-white" style="width: 70px;">Dowry<br>Death<br>(304B)</th>
                                    <th class="bg-primary bg-opacity-75 text-white" style="width: 70px;">Fatal</th>
                                    <th class="bg-primary bg-opacity-75 text-white" style="width: 70px;">Non-Fatal</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for entry in form_data %}
                                <tr class="text-center">
                                    <td>{{ loop.index }}</td>
                                    <td class="text-start">{{ entry.district }}</td>
                                    <td>{{ entry.date.strftime('%d-%m-%Y') }}</td>
                                    <td data-field="bodily_murder_gain" data-entry="{{ entry.id }}">-</td>
                                    <td data-field="bodily_murders" data-entry="{{ entry.id }}">-</td>
                                    <td data-field="bodily_attempt_murder" data-entry="{{ entry.id }}">-</td>
                                    <td data-field="bodily_c_homicides" data-entry="{{ entry.id }}">-</td>
                                    <td data-field="bodily_grave_hurts" data-entry="{{ entry.id }}">-</td>
                                    <td data-field="bodily_simple_hurts" data-entry="{{ entry.id }}">-</td>
                                    <td data-field="property_dacoity" data-entry="{{ entry.id }}">-</td>
                                    <td data-field="property_robbery" data-entry="{{ entry.id }}">-</td>
                                    <td data-field="property_hbs_day" data-entry="{{ entry.id }}">-</td>
                                    <td data-field="property_hbs_night" data-entry="{{ entry.id }}">-</td>
                                    <td data-field="property_ordinary_thefts" data-entry="{{ entry.id }}">-</td>
                                    <td data-field="caw_rape" data-entry="{{ entry.id }}">-</td>
                                    <td data-field="caw_others" data-entry="{{ entry.id }}">-</td>
                                    <td data-field="caw_pocso_sec34_56_grave" data-entry="{{ entry.id }}">-</td>
                                    <td data-field="caw_pocso_others_sec12" data-entry="{{ entry.id }}">-</td>
                                    <td data-field="caw_dowry_death" data-entry="{{ entry.id }}">-</td>
                                    <td data-field="sc_st_cases" data-entry="{{ entry.id }}">-</td>
                                    <td data-field="riotings" data-entry="{{ entry.id }}">-</td>
                                    <td data-field="kidnappings" data-entry="{{ entry.id }}">-</td>
                                    <td data-field="cheatings" data-entry="{{ entry.id }}">-</td>
                                    <td data-field="cyber_offences" data-entry="{{ entry.id }}">-</td>
                                    <td data-field="road_accidents_fatal" data-entry="{{ entry.id }}">-</td>
                                    <td data-field="road_accidents_non_fatal" data-entry="{{ entry.id }}">-</td>
                                    <td data-field="other_ipc_stup_drugs" data-entry="{{ entry.id }}">-</td>
                                    <td data-field="sll_cases" data-entry="{{ entry.id }}">-</td>
                                    <td data-field="crpc_174" data-entry="{{ entry.id }}">-</td>
                                    <td data-field="missing_cases" data-entry="{{ entry.id }}">-</td>
                                    <td data-field="others_if_any" data-entry="{{ entry.id }}">-</td>
                                    <td>
                                        <div class="btn-group" role="group">
                                            <button class="btn btn-sm btn-outline-info view-details-btn" data-entry-id="{{ entry.id }}">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                        {% else %}
                        <!-- Standard table for other forms -->
                        <table class="table table-striped table-hover" id="formDataTable">
                            <thead class="table-dark">
                                <tr>
                                    <th>District</th>
                                    <th>Date</th>
                                    {% for field in form_config.fields %}
                                        {% if field.type not in ['section', 'subsection'] %}
                                    <th>{{ field.label }}</th>
                                        {% endif %}
                                    {% endfor %}
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for entry in form_data %}
                                <tr>
                                    <td>{{ entry.district }}</td>
                                    <td>{{ entry.date.strftime('%d-%m-%Y') }}</td>
                                    {% for field in form_config.fields %}
                                        {% if field.type not in ['section', 'subsection'] %}
                                    <td class="field-data" data-field="{{ field.name }}" data-entry="{{ entry.id }}">
                                        <!-- Data will be populated by JavaScript -->
                                    </td>
                                        {% endif %}
                                    {% endfor %}
                                    <td>
                                        <div class="btn-group" role="group">
                                            <button class="btn btn-sm btn-outline-info view-details-btn" data-entry-id="{{ entry.id }}">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                            <a href="{{ url_for('admin.district_view', district_name=entry.district) }}" 
                                               class="btn btn-sm btn-outline-primary">
                                                <i class="fas fa-map-marker-alt"></i>
                                            </a>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                        {% endif %}
                    </div>
                    
                    <!-- Pagination -->
                    <nav aria-label="Form data pagination" class="mt-3">
                        <ul class="pagination justify-content-center">
                            <li class="page-item disabled">
                                <a class="page-link" href="#" tabindex="-1">Previous</a>
                            </li>
                            <li class="page-item active">
                                <a class="page-link" href="#">1</a>
                            </li>
                            <li class="page-item">
                                <a class="page-link" href="#">2</a>
                            </li>
                            <li class="page-item">
                                <a class="page-link" href="#">3</a>
                            </li>
                            <li class="page-item">
                                <a class="page-link" href="#">Next</a>
                            </li>
                        </ul>
                    </nav>
                    {% else %}
                    <div class="text-center py-5">
                        <i class="fas fa-file-alt fa-3x text-muted mb-3"></i>
                        <h5>No data available</h5>
                        <p class="text-muted">No districts have submitted data for {{ form_config.name }} yet.</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Detail Modal -->
<div class="modal fade" id="detailModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Entry Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="modalContent">
                <!-- Details will be loaded here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="printBtn">
                    <i class="fas fa-print me-1"></i>Print
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<!-- Template data for JavaScript -->
<script type="application/json" id="formData">{{ form_data | tojson }}</script>
<script type="application/json" id="formConfig">{{ form_config | tojson }}</script>

<script>
// Load template data
let formDataJson = [];
let formConfigJson = {};

try {
    formDataJson = JSON.parse(document.getElementById('formData').textContent || '[]');
    formConfigJson = JSON.parse(document.getElementById('formConfig').textContent || '{}');
} catch (e) {
    console.error('Error loading form data:', e);
}

// Populate table data on page load
document.addEventListener('DOMContentLoaded', function() {
    formDataJson.forEach(entry => {
        if (formConfigJson.fields) {
            formConfigJson.fields.forEach(field => {
                const cell = document.querySelector(`[data-field="${field.name}"][data-entry="${entry.id}"]`);
                if (cell && entry.data) {
                    cell.textContent = entry.data[field.name] || 'N/A';
                }
            });
        }
    });

    // Add event listeners
    document.querySelectorAll('.view-details-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const entryId = parseInt(this.getAttribute('data-entry-id'));
            viewDetails(entryId);
        });
    });

    const exportBtn = document.getElementById('exportBtn');
    if (exportBtn) {
        exportBtn.addEventListener('click', exportToExcel);
    }

    const exportPdfBtn = document.getElementById('exportPdfBtn');
    if (exportPdfBtn) {
        exportPdfBtn.addEventListener('click', exportToPdf);
    }

    const printBtn = document.getElementById('printBtn');
    if (printBtn) {
        printBtn.addEventListener('click', printModal);
    }
});

function viewDetails(entryId) {
    const entry = formDataJson.find(e => e.id === entryId);
    if (!entry) return;
    
    const modalContent = document.getElementById('modalContent');
    let html = `
        <div class="row mb-3">
            <div class="col-md-6">
                <strong>District:</strong> ${entry.district}
            </div>
            <div class="col-md-6">
                <strong>Date:</strong> ${new Date(entry.date).toLocaleDateString('en-GB')}
            </div>
        </div>
        <hr>
        <h6>Form Data:</h6>
        <div class="row">
    `;
    
    if (formConfigJson.fields && entry.data) {
        formConfigJson.fields.forEach(field => {
            html += `
                <div class="col-md-6 mb-3">
                    <div class="card">
                        <div class="card-body">
                            <h6 class="card-title">${field.label}</h6>
                            <p class="card-text">${entry.data[field.name] || 'N/A'}</p>
                        </div>
                    </div>
                </div>
            `;
        });
    }
    
    html += '</div>';
    modalContent.innerHTML = html;
    
    const modal = new bootstrap.Modal(document.getElementById('detailModal'));
    modal.show();
}

function exportToPdf() {
    // For PDF export, use browser's print to PDF functionality
    // This preserves the beautiful table formatting with colors
    const printWindow = window.open('', '_blank');
    const tableHtml = document.getElementById('crimeWeeklyTable').outerHTML;
    
    printWindow.document.write(`
        <html>
            <head>
                <title>Head Wise Crime Weekly Statement</title>
                <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
                <style>
                    @page {
                        size: A3 landscape;
                        margin: 10mm;
                    }
                    body {
                        font-family: Arial, sans-serif;
                        font-size: 8px;
                    }
                    table {
                        width: 100%;
                        border-collapse: collapse;
                        font-size: 7px;
                    }
                    th, td {
                        border: 1px solid #000;
                        padding: 3px 2px;
                        text-align: center;
                    }
                    .bg-success { background-color: #198754 !important; }
                    .bg-warning { background-color: #ffc107 !important; }
                    .bg-danger { background-color: #dc3545 !important; }
                    .bg-info { background-color: #0dcaf0 !important; }
                    .bg-primary { background-color: #0d6efd !important; }
                    .bg-secondary { background-color: #6c757d !important; }
                    .bg-dark { background-color: #212529 !important; }
                    .text-white { color: white !important; }
                    h2 { text-align: center; margin-bottom: 20px; }
                    .print-info { text-align: right; font-size: 9px; margin-bottom: 10px; }
                </style>
            </head>
            <body>
                <h2>Head Wise Crime Weekly Statement</h2>
                <div class="print-info">
                    Generated on: ${new Date().toLocaleString('en-IN', {timeZone: 'Asia/Kolkata'})}
                </div>
                ${tableHtml}
                <script>
                    window.onload = function() { 
                        window.print(); 
                        window.onafterprint = function() {
                            window.close();
                        };
                    };
                <\/script>
            </body>
        </html>
    `);
    printWindow.document.close();
}

function exportToExcel() {
    let csvContent = "data:text/csv;charset=utf-8,";
    
    // Header
    let headers = ['District', 'Date'];
    if (formConfigJson.fields) {
        formConfigJson.fields.forEach(field => {
            if (field.type !== 'section' && field.type !== 'subsection') {
                headers.push(field.label);
            }
        });
    }
    csvContent += headers.join(',') + '\n';
    
    // Data rows
    formDataJson.forEach(entry => {
        let row = [entry.district, new Date(entry.date).toLocaleDateString('en-GB')];
        if (formConfigJson.fields && entry.data) {
            formConfigJson.fields.forEach(field => {
                if (field.type !== 'section' && field.type !== 'subsection') {
                    row.push(entry.data[field.name] || '');
                }
            });
        }
        csvContent += row.map(field => `"${field}"`).join(',') + '\n';
    });
    
    // Download
    const encodedUri = encodeURI(csvContent);
    const link = document.createElement("a");
    link.setAttribute("href", encodedUri);
    link.setAttribute("download", `${formConfigJson.name || 'form'}_data.csv`);
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}

function printModal() {
    const modalContent = document.getElementById('modalContent').innerHTML;
    const printWindow = window.open('', '_blank');
    printWindow.document.write(`
        <html>
            <head>
                <title>${formConfigJson.name || 'Form'} - Entry Details</title>
                <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
            </head>
            <body class="p-4">
                <h2>${formConfigJson.name || 'Form'} - Entry Details</h2>
                ${modalContent}
                <script>window.onload = function() { window.print(); }<\/script>
            </body>
        </html>
    `);
    printWindow.document.close();
}
</script>
{% endblock %}
